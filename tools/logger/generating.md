# Generating log marshalers

Log marshalers can be automatically generated, similar to the stringer
example in [this blog post](https://blog.golang.org/generate).

Consider a `struct` like so:

```golang

type Org struct {
    Shortname string
	GUID string
}
```

## Field tags

To specify the field name to log these as, we first need to annotate
this:

```golang

type Org struct
    Shortname  string `log:"or.org.shortname"`
    GUID       string `log:"or.org.guid"`
}

```

With the addition of the `log` tags for fields (which matches the [standard
attributes](https://app.datadoghq.com/logs/pipelines/standard-attributes)),
we can use
[logger](https://github.com/getoutreach/gobox/tree/master/tools/logger)
to generate the `MarshalLog` method:

```bash

# run from directory where the Org struct is stored
$> go run github.com/getoutreach/gobox/tools/logger -output marshalers.go
$> cat marshalers.go
// Code generated by "logger -output marshalers.go"; DO NOT EDIT.

package log

func (s *Org) MarshalLog(addField func(key string, value interface{})) {
	if s == nil {
		return
	}
	addField(or.org.shortname, Shortname)
	addField(or.org.guid, GUID)
}
```

### Annotations
Supported annotations:

- `omitempty`: makes the field optional.

    It is available for basic types, types aliased to a basic type,
    and pointers of any type. The annotation parser does **not**
    validate if the annotation is applied to supported types.
    
    Example:

    ```go
    type Org struct
        Shortname  string  `log:"or.org.shortname,omitempty"`
        GUID       *Custom `log:"or.org.guid,omitempty"`
    }
    ```

    Generated code (post-formatted with `gofmt`):
    
    ```go
    func (s *Org) MarshalLog(addField func(key string, value interface{})) {
        if s == nil {
            return
        }
        if s.Shortname != "" {
            addField("or.org.shortname", s.Shortname)
        }
        if s.GUID != nil {
            addField("or.org.guid", s.GUID)
        }
    }
    ```


## Using go generate

Go `generate` is the standard way to generate pre-build artifacts
(which are checked in rather than made part of the circle-build).
Once the following line is added to **one go file** in a directory,
all structs which have `log:"..."` annotations will automatically have
their corresponding marshalers generated when `go generate` is run.

    //go:generate go run github.com/getoutreach/gobox/tools/logger -output marshalers.go

Note that `go generate` can be run from the root of the project via
`go generate ./...`.
