# Generating log marshalers

Log marshalers can be automatically generated, similar to the stringer
example in [this blog post](https://blog.golang.org/generate).

Consider a `struct` like so:

```golang

type OrgInfo struct {
    Org string
    Guid string
}
```

## Field tags

To specify the field name to log these as, we first need to annotate
this:

```golang

type OrgInfo struct
    Org  string `log:"or.org.shortname"`
    Guid string `log:"or.org.guid"`
}

```

With the addition of the log tags `ie. log:"xyz"` for fields (xyz matches the [standard
attributes](https://app.datadoghq.com/logs/pipelines/standard-attributes)),
we can use
[logger](https://github.com/getoutreach/gobox/tree/master/tools/logger)
to generate the `MarshalLog` method:

```bash

# run from directory where the OrgInfo struct is stored
$> go run github.com/getoutreach/gobox/tools/logger -output marshalers.go
$> cat marshalers.go
// Code generated by "logger -output marshalers.go"; DO NOT EDIT.

package log

func (s *OrgInfo) MarshalLog(addField func(key string, value interface{})) {
	if s == nil {
		return
	}
	addField(or.org.shortname, Org)
	addField(or.org.guid, Guid)
}
```

### Annotations:
These tags for fields also have limited support for annotations: `ie. log:"xyz,annotation"`.

Supported annotations:

- **omitempty**: makes the field optional.

    `omitempty` annotation is available for simple built-in types or
    custom types with underlying type being built-in or pointers of any type.
    
    Example:
    ```go
    type OrgInfo struct
        Org  string `log:"or.org.shortname,omitempty"`
        Guid *Custom `log:"or.org.guid,omitempty"`
    }
    ```

    Generated code:
    
    ```go
    func (s *OrgInfo) MarshalLog(addField func(key string, value interface{})) {
        if s == nil {
            return
        }
        if s.Org != "" {
            addField("or.org.shortname", s.Org)
        }
        if s.Guid != nil {
            addField("or.org.guid", s.Guid)
        }
    }
    ```


## Using go generate

Go `generate` is the standard way to generate pre-build artifacts
(which are checked in rather than made part of the circle-build).
Once the following line is added to **one go file** in a directory,
all structs which have `log:"..."` annotations will automatically have
their corresponding marshalers generated when `go generate` is run.

    //go:generate go run github.com/getoutreach/gobox/tools/logger -output marshalers.go

Note that `go generate` can be run from the root of the project via
`go generate ./...`.
